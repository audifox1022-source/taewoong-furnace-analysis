<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ì—´ë¡œ íš¨ìœ¨ ë¶„ì„ ì•± (í˜¸ê¸° ë…ë¦½ ì‚¬ì´í´)</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ìš©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        /* Bar chart styling for visualization */
        .bar-chart-bar {
            height: 10px;
            background-color: #3b82f6; /* Tailwind blue-500 */
            border-radius: 9999px;
            transition: width 0.5s ease-out;
        }
        /* Custom table styling for copyable data */
        .copyable-table {
            border-collapse: collapse;
            width: 100%;
        }
        .copyable-table th, .copyable-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 6px;
            font-size: 0.75rem; /* text-xs */
            text-align: left;
        }
        .copyable-table thead {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-100 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10 p-6 bg-white shadow-lg rounded-xl">
            <h1 class="text-3xl font-extrabold text-blue-800 tracking-tight">
                ğŸ”¥ íƒœì›… ê°€ì—´ë¡œ íš¨ìœ¨ ë¶„ì„ ë° ì•„ì´ë””ì–´ ìƒì„±ê¸°
            </h1>
            <p class="mt-2 text-gray-600">
                ê°€ìŠ¤ì›ë‹¨ìœ„(Nm3/Ton) ì ˆê°ì„ ìœ„í•œ AI ê¸°ë°˜ ë°ì´í„° í†µì°°ë ¥ ë„êµ¬ (í˜¸ê¸°ë³„ ë…ë¦½ ê³„ì‚° ì§€ì›)
            </p>
        </header>

        <!-- ë°ì´í„° ì…ë ¥ ë° ë¶„ì„ ì„¹ì…˜ -->
        <main class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">
                1ë‹¨ê³„: ë°ì´í„° ì—…ë¡œë“œ &amp; ë¶„ì„ ì‚¬ì´í´ ì„¤ì •
            </h2>

            <div class="space-y-6">
                <!-- 1. íŒŒì¼ ì—…ë¡œë“œ -->
                <div>
                    <label for="file-input" class="block text-sm font-medium text-gray-700 mb-2">
                        â‘  **í•„ìˆ˜**: ì´ë ¥ ë°ì´í„° (ê°€ìŠ¤ëˆ„ì ì§€ì¹¨, ì‹œê°„ í¬í•¨) &amp; â‘¡ **ì„ íƒ**: ì§‘ê³„ ë°ì´í„° (ì¤‘ëŸ‰, ë‹¨ìœ„)
                    </label>
                    <input type="file" id="file-input" accept=".csv, .txt, .xlsx" multiple
                        class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100 cursor-pointer"
                    >
                </div>

                <!-- ì—…ë¡œë“œëœ íŒŒì¼ í˜„í™© í‘œì‹œ -->
                <div id="file-status" class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm">
                    <p class="text-yellow-800 font-semibold mb-1">íŒŒì¼ ì¤€ë¹„ ìƒíƒœ:</p>
                    <ul id="file-list" class="list-disc ml-5 text-gray-600">
                        <li>âœ… í•„ìˆ˜: ì´ë ¥ ë°ì´í„° (ê°€ìŠ¤ëˆ„ì ì§€ì¹¨ í¬í•¨)ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</li>
                        <li>(ì„ íƒ) ì§‘ê³„ ë°ì´í„° (ì¤‘ëŸ‰, ë‹¨ìœ„)ë¥¼ ì—…ë¡œë“œí•˜ë©´ AI ë¶„ì„ì´ ë”ìš± ì •ë°€í•´ì§‘ë‹ˆë‹¤.</li>
                    </ul>
                </div>
                
                <!-- 2. ì‚¬ì´í´ ì¢…ë£Œ ì‹œì  ì…ë ¥ í•„ë“œ (ì´ë ¥ ë°ì´í„° ë¡œë“œ í›„ í™œì„±í™”) -->
                <div id="cycle-input-section" class="space-y-4 p-4 border rounded-lg bg-gray-50 hidden">
                    <h3 class="text-lg font-semibold text-gray-700">ë¶„ì„ ì‚¬ì´í´ ì¢…ë£Œ ì‹œì  ëª©ë¡ ì„¤ì •</h3>
                    <p class="text-sm text-gray-600 mb-2">
                        * ê³„ì‚°í•  ì‚¬ì´í´ì˜ **ì¢…ë£Œ ì‹œê°**ì„ ë‚˜ì—´í•´ ì£¼ì„¸ìš”. (<span class="font-bold text-red-500">í˜¸ê¸°ë³„ë¡œ ì´ì „ ì¢…ë£Œ ì‹œì ë¶€í„° ê³„ì‚°ë©ë‹ˆë‹¤.</span>)
                        <br>
                        <span class="font-bold text-blue-700">ğŸ’¡ ìƒˆë²½ ì‹œê°„ (00:00~08:00)ì€ ìë™ìœ¼ë¡œ ë‹¤ìŒ ë‚ ì§œë¡œ ë³´ì •ë©ë‹ˆë‹¤.</span>
                    </p>
                    <label for="cycle-endpoints" class="block text-sm font-medium text-gray-700">ì…ë ¥ í˜•ì‹: [í˜¸ê¸°] [YYMMDD] [ì£¼/ì•¼] [HH:MM]</label>
                    <textarea id="cycle-endpoints" rows="5" placeholder="ì˜ˆ:&#10;18í˜¸ê¸° 251124 ì£¼ 03:59 (-> 11-25 03:59ë¡œ ì¸ì‹)&#10;20í˜¸ê¸° 251124 ì£¼ 20:16&#10;18í˜¸ê¸° 251125 ì£¼ 05:41 (-> 11-26 05:41ë¡œ ì¸ì‹)&#10;20í˜¸ê¸° 251126 ì•¼ 05:41 (-> 11-27 05:41ë¡œ ì¸ì‹)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"></textarea>
                    
                    <button id="calculate-button" class="w-full py-2 px-4 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out disabled:opacity-50">
                        ì‚¬ì´í´ë³„ ê°€ìŠ¤ ì‚¬ìš©ëŸ‰ ê³„ì‚° ë° ì‹œê°í™”
                    </button>

                    <!-- ê³„ì‚° ê²°ê³¼ ë° ì‹œê°í™” ì˜ì—­ -->
                    <div id="visualization-output" class="mt-4 p-3 bg-white border rounded-md min-h-[50px]">
                        <p class="text-sm text-gray-700 font-semibold mb-2">ì‚¬ì´í´ë³„ ê°€ìŠ¤ ì‚¬ìš©ëŸ‰ ê²°ê³¼ (NmÂ³):</p>
                        
                        <!-- NEW: ë³µì‚¬ ê°€ëŠ¥í•œ í‘œ ë°ì´í„° ì˜ì—­ (ì‚¬ìš©ìê°€ ì§ì ‘ ë³µì‚¬ ê°€ëŠ¥) -->
                        <div id="copy-data-container" class="mb-4">
                            <label class="block text-xs font-medium text-gray-700 mb-1">ë³µì‚¬ ê°€ëŠ¥í•œ ë°ì´í„° í…Œì´ë¸”:</label>
                            <div id="copyable-table-output" class="overflow-x-auto border rounded-md">
                                <!-- Table content generated by JS -->
                                <table class="copyable-table">
                                    <thead><tr><th>ë‚ ì§œ</th><th>ì‚¬ìš©ì „ ì§€ì¹¨</th><th>ì‚¬ìš©í›„ ì§€ì¹¨</th><th>í˜¸ê¸°</th><th>ì‚¬ìš©ëŸ‰(NmÂ³)</th></tr></thead>
                                    <tbody><tr><td colspan="5" class="text-center text-gray-500">ê³„ì‚° ê²°ê³¼ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</td></tr></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- NEW: í˜¸ê¸° í•„í„°ë§ ë“œë¡­ë‹¤ìš´ -->
                        <div id="hoGi-filter-container" class="flex justify-between items-center mb-3 hidden">
                            <div class="flex items-center space-x-2">
                                <label for="hoGi-filter" class="text-sm font-medium text-gray-700">ê²°ê³¼ í•„í„°ë§:</label>
                                <select id="hoGi-filter" class="p-1 border rounded-md text-sm">
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                        </div>

                        <!-- ì—´ ë³µì‚¬ ë²„íŠ¼ ê·¸ë£¹ -->
                        <div id="copy-tools" class="mb-4 space-y-2 hidden">
                            <p class="text-xs text-gray-600 font-medium">âœ¨ ì—´ ë³µì‚¬ ì˜µì…˜: ì›í•˜ëŠ” ì—´ë§Œ ì„ íƒí•˜ì—¬ ìƒˆ ì¤„ë¡œ ë³µì‚¬</p>
                            <div class="flex flex-wrap gap-2">
                                <button data-copy-key="date" class="copy-column-btn px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50">ë‚ ì§œ</button>
                                <button data-copy-key="startGas" class="copy-column-btn px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50">ì‚¬ìš©ì „ ì§€ì¹¨</button>
                                <button data-copy-key="endGas" class="copy-column-btn px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50">ì‚¬ìš©í›„ ì§€ì¹¨</button>
                                <button data-copy-key="hoGi" class="copy-column-btn px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50">í˜¸ê¸°</button>
                                <button data-copy-key="usage" class="copy-column-btn px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50">ì‚¬ìš©ëŸ‰(NmÂ³)</button>
                            </div>
                            <span id="copy-message" class="text-xs text-green-600 opacity-0 transition-opacity">ë³µì‚¬ ì™„ë£Œ!</span>
                        </div>
                        
                        <!-- ì‹œê°í™” í…Œì´ë¸” (ìˆœë²ˆ, ì‹œì‘/ì¢…ë£Œ ì‹œê°„, ì‹œê°í™”) -->
                        <div id="gas-results-table" class="mt-2 text-sm">N/A</div>
                    </div>
                </div>

                <!-- 3. ë¶„ì„ ìš”ì²­ ë²„íŠ¼ -->
                <button id="analyze-button"
                        class="w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out disabled:opacity-50"
                        disabled>
                    ğŸ’¡ í†µí•© ë°ì´í„° ê¸°ë°˜ AI ë¶„ì„ ë° ì•„ì´ë””ì–´ ìƒì„± ìš”ì²­
                </button>
            </div>

            <!-- ë¡œë”© ìƒíƒœ ë©”ì‹œì§€ -->
            <div id="loading-spinner" class="mt-6 hidden text-center">
                <div class="flex items-center justify-center space-x-2">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-blue-600 font-medium">ë°ì´í„° ë¶„ì„ ì¤‘... (ìµœì í™”ëœ ê°€ìŠ¤ ì ˆê° ì•„ì´ë””ì–´ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.)</span>
                </div>
            </div>

            <!-- 4. ë¶„ì„ ê²°ê³¼ ì¶œë ¥ -->
            <div class="mt-8 pt-6 border-t">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">
                    2ë‹¨ê³„: AI ë¶„ì„ ê²°ê³¼ ë° ì‹¤í–‰ ì•„ì´ë””ì–´
                </h2>
                <div id="result-output" class="p-4 bg-gray-50 border border-gray-200 rounded-lg whitespace-pre-wrap text-gray-700 min-h-[300px]">
                    ì—¬ê¸°ì— Gemini AIê°€ ë¶„ì„í•œ ê°€ì—´ íŒ¨í„´ ë¹„íš¨ìœ¨ì„±, ê°€ìŠ¤ Loss ê°€ëŠ¥ ì§€ì , ê·¸ë¦¬ê³  Nm3/Ton ì ˆê°ì„ ìœ„í•œ **ì‹¤í–‰ ê°€ëŠ¥í•œ ì•„ì´ë””ì–´ 3ê°€ì§€**ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Global variables and constants
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // DOM elements
        const fileInput = document.getElementById('file-input');
        const analyzeButton = document.getElementById('analyze-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultOutput = document.getElementById('result-output');
        const fileListElement = document.getElementById('file-list');
        const cycleInputSection = document.getElementById('cycle-input-section');
        const cycleEndpointsInput = document.getElementById('cycle-endpoints');
        const calculateButton = document.getElementById('calculate-button');
        const visualizationOutput = document.getElementById('visualization-output');
        const gasResultsTable = document.getElementById('gas-results-table');
        const copyTools = document.getElementById('copy-tools');
        const copyMessage = document.getElementById('copy-message');
        const hoGiFilterContainer = document.getElementById('hoGi-filter-container');
        const hoGiFilter = document.getElementById('hoGi-filter');
        const copyableTableOutput = document.getElementById('copyable-table-output'); // NEW: Copyable table container


        // Data storage
        let historyDataContent = ''; // Raw CSV content for history data (í•„ìˆ˜)
        let historyDataArray = []; // Parsed array for history data
        let summaryDataContent = ''; // Raw CSV content for summary data (ì„ íƒ)
        let rawCalculationResults = []; // All calculated results before final sorting
        let sortedResultsByInput = []; // Final sorted result set for display/copy
        let cycleAnalysisResults = []; // AI analysis subset: usage that is not 'N/A' and no error

        // --- Helper Functions ---
        
        // CSV/TXT reading with encoding attempts
        const readCsvTxt = async (file) => {
            const attemptRead = (encoding) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, encoding);
            });

            try { return await attemptRead('UTF-8'); } 
            catch (e) { try { return await attemptRead('EUC-KR'); } 
            catch (e2) { return null; } }
        };

        // XLSX reading using SheetJS
        const readXlsx = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const csvText = XLSX.utils.sheet_to_csv(workbook.Sheets[sheetName]);
                    resolve(csvText);
                } catch (error) { reject("ì—‘ì…€ íŒŒì¼ ë³€í™˜ ì˜¤ë¥˜: " + error.message); }
            };
            reader.onerror = (e) => reject("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: " + e.target.error);
            reader.readAsBinaryString(file);
        });
        
        // CSV í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ì—¬ ë°°ì—´ë¡œ ë³€í™˜
        const parseCSV = (csvText, hoGiNum) => { // hoGiNum ì¸ì ì¶”ê°€
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];

            const header = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            // í˜¸ê¸° ì»¬ëŸ¼ì´ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ í—¤ë”ì— ê°•ì œ ì¶”ê°€
            const timeKey = header.find(key => key.includes('ì‹œê°„'));
            if (hoGiNum && !header.some(key => key.includes('í˜¸ê¸°') || key.includes('ê°€ì—´ë¡œëª…'))) {
                header.push('ê°€ì—´ë¡œí˜¸ê¸°_ì¶”ì •');
            }


            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length < header.length - 1) continue; 

                const row = {};
                header.forEach((h, index) => {
                    row[h] = values[index]?.trim() || '';
                });
                
                // í˜¸ê¸° ë²ˆí˜¸ë¥¼ íŒŒì¼ëª…ì—ì„œ ì¶”ì¶œí•˜ì—¬ ê°•ì œ ì£¼ì…
                if (hoGiNum && header.includes('ê°€ì—´ë¡œí˜¸ê¸°_ì¶”ì •')) {
                    row['ê°€ì—´ë¡œí˜¸ê¸°_ì¶”ì •'] = hoGiNum;
                }
                
                data.push(row);
            }
            return data;
        };

        // ê°„ì†Œí™”ëœ ë‚ ì§œ í˜•ì‹ íŒŒì‹± (YYMMDD + HH:MM ì…ë ¥ ì‹œ ë‹¤ìŒ ë‚ ë¡œ ë³´ì • ë¡œì§ ì¶”ê°€)
        const parseSimplifiedTime = (input) => {
            const match = input.match(/(\d{1,2}í˜¸ê¸°?)\s+(\d{6})\s+(ì£¼|ì•¼)\s+(\d{2}:\d{2})/);
            if (!match) return null;

            const [_, hoGiRaw, datePart, shiftPart, timePart] = match;
            const hoGi = hoGiRaw.replace('í˜¸ê¸°', '').trim();
            const year = '20' + datePart.substring(0, 2); 
            const month = datePart.substring(2, 4);
            const day = datePart.substring(4, 6);
            const hour = parseInt(timePart.substring(0, 2));
            
            const currentYear = new Date().getFullYear(); 
            const inputYear = parseInt(year);

            // 1. ê¸°ë³¸ Date ê°ì²´ ìƒì„±
            let date = new Date(`${inputYear < currentYear - 5 ? currentYear : year}-${month}-${day} ${timePart}:00`);

            if (isNaN(date)) return null;

            // 2. ìƒˆë²½ ì‹œê°„(00:00 ~ 08:00)ì¸ ê²½ìš°, ë‚ ì§œë¥¼ í•˜ë£¨ ë’¤ë¡œ ë³´ì •
            if (hour >= 0 && hour < 8) {
                date.setDate(date.getDate() + 1);
            }
            
            // í¬ë§·íŒ… í›„ ë°˜í™˜
            const fullTimeStr = date.toISOString().slice(0, 19).replace('T', ' ');

            return {
                hoGi: hoGi,
                fullTimeStr: fullTimeStr,
                rawInput: input
            };
        };

        // ê°€ìŠ¤ ëˆ„ì  ì§€ì¹¨ì„ ì´ìš©í•œ ì‚¬ìš©ëŸ‰ ê³„ì‚° (ë””ë²„ê¹… ì •ë³´ ì¶”ê°€)
        const getGasUsage = (startTimeStr, endTimeStr, startHoGi, endHoGi) => {
            // í˜¸ê¸° í‚¤ëŠ” ë‘ ê°€ì§€ë¥¼ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ 'ê°€ì—´ë¡œí˜¸ê¸°_ì¶”ì •'ì„ ì‚¬ìš©
            const hoGiKey = Object.keys(historyDataArray[0]).find(key => key.includes('í˜¸ê¸°') || key.includes('ê°€ì—´ë¡œëª…')) || 'ê°€ì—´ë¡œí˜¸ê¸°_ì¶”ì •';
            const timeKey = Object.keys(historyDataArray[0]).find(key => key.includes('ì‹œê°„'));
            const gasKey = Object.keys(historyDataArray[0]).find(key => key.includes('ê°€ìŠ¤ëˆ„ì ì§€ì¹¨'));
            
            if (!timeKey || !gasKey) {
                return { usage: NaN, startGas: '', endGas: 'N/A', error: 'ì‹œê°„ ë˜ëŠ” ê°€ìŠ¤ëˆ„ì ì§€ì¹¨ ì»¬ëŸ¼ ëˆ„ë½' };
            }

            const findGasEntry = (timeStr, targetHoGi) => {
                const inputTime = new Date(timeStr).getTime();
                
                let dataToSearch = historyDataArray;
                
                // í˜¸ê¸° í‚¤ê°€ ìˆë‹¤ë©´ í•´ë‹¹ í˜¸ê¸° ë°ì´í„°ë§Œ í•„í„°ë§
                if (hoGiKey !== 'ê°€ì—´ë¡œí˜¸ê¸°_ì¶”ì •') { 
                    dataToSearch = historyDataArray.filter(row => String(row[hoGiKey]).includes(targetHoGi));
                } else {
                    // í˜¸ê¸° í‚¤ê°€ ì—†ìœ¼ë©´ (ê°€ì—´ë¡œí˜¸ê¸°_ì¶”ì • í•„ë“œ ì‚¬ìš©), í•´ë‹¹ ì¶”ì • í˜¸ê¸°ë§Œ í•„í„°ë§
                    dataToSearch = historyDataArray.filter(row => String(row[hoGiKey]).includes(targetHoGi));
                }
                
                if (dataToSearch.length === 0) {
                     return null; 
                }
                
                const sortedData = [...dataToSearch].sort((a, b) => new Date(a[timeKey]) - new Date(b[timeKey]));

                let closestEntry = null;
                let minTimeDiff = Infinity;
                
                for (const entry of sortedData) {
                    const entryTime = new Date(entry[timeKey]).getTime();
                    
                    if (entryTime <= inputTime) {
                        const timeDiff = inputTime - entryTime;
                        if (timeDiff < minTimeDiff) {
                            minTimeDiff = timeDiff;
                            closestEntry = entry;
                        }
                    } else {
                        break; 
                    }
                }
                return closestEntry;
            };

            const startEntry = findGasEntry(startTimeStr, startHoGi); 
            const endEntry = findGasEntry(endTimeStr, endHoGi); 

            const endGasRaw = endEntry ? parseFloat(endEntry[gasKey]) : NaN;
            const startGasRaw = startEntry ? parseFloat(startEntry[gasKey]) : NaN;
            
            // --- NEW: ë””ë²„ê¹… ì •ë³´ ì¶œë ¥ ---
            console.log(`[DEBUG] Target HoGi: ${endHoGi}`);
            console.log(`[DEBUG] Start Time: ${startTimeStr}, Found Gas: ${startEntry ? startEntry[gasKey] : 'N/A'}`);
            console.log(`[DEBUG] End Time: ${endTimeStr}, Found Gas: ${endEntry ? endEntry[gasKey] : 'N/A'}`);
            // -----------------------------

            // 1. ì¢…ë£Œ ì§€ì¹¨ ëˆ„ë½ í™•ì¸
            if (!endEntry || isNaN(endGasRaw)) {
                 return { usage: 'N/A', startGas: '', endGas: 'N/A', error: `ì¢…ë£Œ(${endHoGi}í˜¸ê¸° @ ${endTimeStr.slice(5, 16)}) ì‹œì  ë°ì´í„° ëˆ„ë½` };
            }
            
            // 2. ì‹œì‘ ì§€ì¹¨ ëˆ„ë½ í™•ì¸ (ì‚¬ìš©ëŸ‰ì´ 'N/A'ê°€ ë¨)
            if (!startEntry || isNaN(startGasRaw)) {
                 return { usage: 'N/A', startGas: '', endGas: endGasRaw.toFixed(0), error: `ì‹œì‘(${startHoGi}í˜¸ê¸° @ ${startTimeStr.slice(5, 16)}) ì‹œì  ë°ì´í„° ëˆ„ë½ (ì°¨ë¶„ ë¶ˆê°€)` };
            }
            
            // 3. ì •ìƒì ì¸ ì°¨ë¶„ ê³„ì‚°
            if (endGasRaw < startGasRaw) {
                // ì´ ê²½ìš° ë°ì´í„° ì˜¤ë¥˜(ëˆ„ì  ì§€ì¹¨ì¸ë° ê°’ì´ ê°ì†Œí•¨)ë¥¼ ëª…í™•íˆ ê²½ê³ 
                const errorMsg = `ì§€ì¹¨ ê°ì†Œ ì˜¤ë¥˜: ì¢…ë£Œ(${endGasRaw}) < ì‹œì‘(${startGasRaw})`;
                resultOutput.innerHTML += `<div class="text-red-600 mt-2">ğŸš¨ ê²½ê³ : ${endHoGi}í˜¸ê¸° ì‚¬ì´í´ì—ì„œ ${errorMsg}ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì›ë³¸ ë°ì´í„°ì˜ ëˆ„ì  ì§€ì¹¨ì„ í™•ì¸í•˜ì„¸ìš”.</div>`;
                return { usage: 'N/A', startGas: startGasRaw.toFixed(0), endGas: endGasRaw.toFixed(0), error: errorMsg };
            }

            const usage = endGasRaw - startGasRaw;
            
            if (usage <= 0.001) { 
                return { usage: usage.toFixed(2), startGas: startGasRaw.toFixed(0), endGas: endGasRaw.toFixed(0), error: 'ì‚¬ìš©ëŸ‰ 0 (ì§€ì¹¨ ë™ì¼ ë˜ëŠ” ë°ì´í„° ë¶€ì¡±)' };
            }

            return { usage: usage.toFixed(2), startGas: startGasRaw.toFixed(0), endGas: endGasRaw.toFixed(0), error: null };
        };

        // --- Visualization Functions ---
        
        // í˜¸ê¸° í•„í„° ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        const updateHoGiFilter = () => {
            hoGiFilterContainer.classList.add('hidden');
            hoGiFilter.innerHTML = '<option value="all">ì „ì²´ í˜¸ê¸°</option>';
            
            if (rawCalculationResults.length === 0) return;
            
            // rawCalculationResultsë¥¼ ì‚¬ìš©í•˜ì—¬ í˜¸ê¸° ëª©ë¡ ì¶”ì¶œ
            const uniqueHoGis = [...new Set(rawCalculationResults.map(r => r.hoGi))].sort((a, b) => parseInt(a) - parseInt(b));
            
            uniqueHoGis.forEach(hoGi => {
                const option = document.createElement('option');
                option.value = hoGi;
                option.textContent = `${hoGi}í˜¸ê¸°`;
                hoGiFilter.appendChild(option);
            });
            
            hoGiFilterContainer.classList.remove('hidden');
            
            // í•„í„° ë³€ê²½ ì‹œ í…Œì´ë¸” ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            hoGiFilter.removeEventListener('change', filterAndRedrawTable);
            hoGiFilter.addEventListener('change', filterAndRedrawTable);
        };
        
        // í…Œì´ë¸”ì„ í•„í„°ë§í•˜ê³  ë‹¤ì‹œ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ (ì •ë ¬ ë¡œì§ ì¶”ê°€ë¨)
        const filterAndRedrawTable = () => {
            const selectedHoGi = hoGiFilter.value;
            
            let filteredResults;
            if (selectedHoGi === 'all') {
                filteredResults = [...sortedResultsByInput]; // ì›ë³¸ ë³µì‚¬
            } else {
                filteredResults = sortedResultsByInput.filter(r => r.hoGi === selectedHoGi);
            }
            
            // NEW: ì‚¬ìš©í›„ ì§€ì¹¨ (endGas) ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ê°€ì¥ ìµœê·¼ ë°ì´í„°ê°€ ìœ„ë¡œ)
            filteredResults.sort((a, b) => {
                const endGasA = parseFloat(a.endGas);
                const endGasB = parseFloat(b.endGas);
                
                // N/A, NaN ë˜ëŠ” ì˜¤ë¥˜ëŠ” í•­ìƒ ì•„ë˜ë¡œ
                if (isNaN(endGasA) && isNaN(endGasB)) return 0;
                if (isNaN(endGasA)) return 1;
                if (isNaN(endGasB)) return -1;
                
                return endGasB - endGasA; // Descending sort
            });
            
            drawResultsTable(filteredResults);
            drawCopyableTable(filteredResults); // ë³µì‚¬ í…Œì´ë¸”ë„ í•„í„°ë§ëœ ê²°ê³¼ë¡œ ì—…ë°ì´íŠ¸
            
            // í•„í„°ë§ëœ ê²°ê³¼ë¡œ ë³µì‚¬ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const hasValidCopyData = filteredResults.some(r => r.endGas && r.endGas !== 'N/A');
            document.querySelectorAll('.copy-column-btn').forEach(btn => btn.disabled = !hasValidCopyData);
        };

        // ê³„ì‚° ê²°ê³¼ë¥¼ HTML í…Œì´ë¸”ë¡œ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ (ìˆœë²ˆ, ì‹œê°„, ì‚¬ìš©ëŸ‰, ì‹œê°í™”)
        const drawResultsTable = (resultsToDraw) => {
            let maxUsage = resultsToDraw.reduce((max, r) => {
                const usage = parseFloat(r.usage);
                return (!isNaN(usage) && usage > max) ? usage : max;
            }, 0);

            let tableHtml = `<table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìˆœë²ˆ</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í˜¸ê¸°</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì‹œì‘ â†’ ì¢…ë£Œ ì‹œê°„</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì‚¬ìš©ëŸ‰ (NmÂ³)</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì‹œê°í™”</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">`;

            resultsToDraw.forEach((r, index) => {
                const usage = r.usage;
                const percentage = !isNaN(parseFloat(usage)) && maxUsage > 0 ? (parseFloat(usage) / maxUsage) * 100 : 0;
                
                const formatTime = (timeStr) => timeStr.slice(5, 16); 
                const usageDisplay = r.usage === 'N/A' ? 'N/A (ì°¨ë¶„ ë¶ˆê°€)' : r.usage;

                tableHtml += `
                    <tr>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${index + 1}ì°¨</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-blue-600">${r.hoGi}í˜¸ê¸°</td>
                        <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-500">${r.startTime ? formatTime(r.startTime) : 'N/A (ì‹œì‘ì  ëˆ„ë½)'} â†’ ${formatTime(r.endTime)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-bold ${r.error ? 'text-red-500' : (r.usage === 'N/A' ? 'text-gray-500' : 'text-green-600')}">${r.error ? r.error : usageDisplay}</td>
                        <td class="px-3 py-2">
                            <div class="w-full bg-gray-200 rounded-full">
                                <div class="bar-chart-bar" style="width: ${percentage}%;"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table>`;
            
            gasResultsTable.innerHTML = tableHtml;
        };

        // NEW: ë³µì‚¬ ê°€ëŠ¥í•œ ë°ì´í„° í‘œë¥¼ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
        const drawCopyableTable = (resultsToDraw) => {
            let tableHtml = `<table class="copyable-table">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ì‚¬ìš©ì „ ì§€ì¹¨</th>
                        <th>ì‚¬ìš©í›„ ì§€ì¹¨</th>
                        <th>í˜¸ê¸°</th>
                        <th>ì‚¬ìš©ëŸ‰(NmÂ³)</th>
                    </tr>
                </thead>
                <tbody>`;

            if (resultsToDraw.length === 0) {
                 tableHtml += `<tr><td colspan="5" class="text-center text-gray-500">ìœ íš¨í•œ ê³„ì‚° ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            } else {
                resultsToDraw.forEach(r => {
                    const startGasCopy = r.startGas === 'N/A' || !r.startGas ? '' : r.startGas;
                    const endGasCopy = r.endGas === 'N/A' || !r.endGas ? '' : r.endGas;
                    const usageCopy = r.usage === 'N/A' || r.error ? '' : r.usage;
                    const hoGiCopy = r.hoGi;
                    const rowClass = r.usage === 'N/A' ? 'bg-gray-50 text-gray-500' : '';

                    tableHtml += `
                        <tr class="${rowClass}">
                            <td>${r.datePart}</td>
                            <td>${startGasCopy}</td>
                            <td>${endGasCopy}</td>
                            <td>${hoGiCopy}</td>
                            <td>${usageCopy}</td>
                        </tr>
                    `;
                });
            }

            tableHtml += `</tbody></table>`;
            copyableTableOutput.innerHTML = tableHtml;
        };


        // --- Main Calculation Logic ---

        const analyzeCycles = () => {
            // ì´ˆê¸°í™”
            gasResultsTable.innerHTML = 'N/A';
            visualizationOutput.classList.remove('hidden');
            rawCalculationResults = [];
            sortedResultsByInput = [];
            cycleAnalysisResults = []; 
            copyTools.classList.add('hidden'); 
            copyMessage.classList.remove('opacity-100');
            
            // ë³µì‚¬ í…Œì´ë¸” ì´ˆê¸°í™”
            drawCopyableTable([]); 

            const rawEndpoints = cycleEndpointsInput.value.trim().split('\n').filter(line => line.trim() !== '');
            if (rawEndpoints.length < 1) { 
                gasResultsTable.innerHTML = '<span class="text-red-500 font-bold">âš ï¸ ìµœì†Œ 1ê°œ ì´ìƒì˜ ì‚¬ì´í´ ì¢…ë£Œ ì‹œì ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.</span>';
                return;
            }
            
            const hoGiKeyExistsInFile = !!Object.keys(historyDataArray[0]).find(key => key.includes('í˜¸ê¸°') || key.includes('ê°€ì—´ë¡œëª…'));
            
            let parsedEndpoints = [];
            for (const line of rawEndpoints) {
                const parsed = parseSimplifiedTime(line);
                if (parsed) {
                    parsedEndpoints.push(parsed);
                } else {
                    gasResultsTable.innerHTML = `<span class="text-red-500 font-bold">âš ï¸ ì…ë ¥ í˜•ì‹ ì˜¤ë¥˜: '${line}'ì„ [í˜¸ê¸°] [YYMMDD] [ì£¼/ì•¼] [HH:MM] í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>`;
                    return;
                }
            }
            
            if (parsedEndpoints.length < 1) {
                 gasResultsTable.innerHTML = '<span class="text-red-500 font-bold">âš ï¸ ìœ íš¨í•œ ì‚¬ì´í´ ì¢…ë£Œ ì‹œì ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
                 return;
            }

            // 1. í˜¸ê¸°ë³„ë¡œ ê·¸ë£¹í™” ë° ì‹œê°„ìˆœ ì •ë ¬
            const hoGiGroups = parsedEndpoints.reduce((acc, endpoint) => {
                acc[endpoint.hoGi] = acc[endpoint.hoGi] || [];
                acc[endpoint.hoGi].push(endpoint);
                return acc;
            }, {});
            
            for (const hoGi in hoGiGroups) {
                hoGiGroups[hoGi].sort((a, b) => new Date(a.fullTimeStr) - new Date(b.fullTimeStr));
            }
            
            // 2. í˜¸ê¸°ë³„ ë…ë¦½ì ì¸ ì‚¬ì´í´ ê³„ì‚° ìˆ˜í–‰
            for (const hoGi in hoGiGroups) {
                const endpoints = hoGiGroups[hoGi];
                
                for (let i = 0; i < endpoints.length; i++) {
                    const currentCycleEnd = endpoints[i];
                    
                    let previousCycleEnd = null;
                    if (i > 0) {
                        previousCycleEnd = endpoints[i - 1];
                    }
                    
                    let usageData;

                    if (previousCycleEnd) {
                        // ì°¨ë¶„ ê³„ì‚°
                        usageData = getGasUsage(
                            previousCycleEnd.fullTimeStr, 
                            currentCycleEnd.fullTimeStr, 
                            previousCycleEnd.hoGi,
                            currentCycleEnd.hoGi
                        );
                    } else {
                         // ê·¸ë£¹ ë‚´ ì²« ë²ˆì§¸ ê¸°ë¡ (ì¢…ë£Œ ì§€ì¹¨ë§Œ ê²€ìƒ‰)
                         usageData = getGasUsage(
                            currentCycleEnd.fullTimeStr,
                            currentCycleEnd.fullTimeStr, 
                            currentCycleEnd.hoGi,
                            currentCycleEnd.hoGi
                         );
                         usageData.usage = 'N/A';
                         usageData.startGas = '';
                         usageData.error = usageData.error && usageData.error.includes("ì‹œì  ë°ì´í„° ëˆ„ë½") ? usageData.error : "ì‹œì‘ì  ê¸°ë¡ ì—†ìŒ (ì°¨ë¶„ ê³„ì‚° ë¶ˆê°€)";
                    }
                    
                    rawCalculationResults.push({
                        datePart: currentCycleEnd.fullTimeStr.substring(2, 10).replace(/-/g, ''), 
                        hoGi: currentCycleEnd.hoGi,
                        startTime: previousCycleEnd ? previousCycleEnd.fullTimeStr : 'N/A',
                        endTime: currentCycleEnd.fullTimeStr,
                        usage: usageData.usage,
                        startGas: usageData.startGas,
                        endGas: usageData.endGas,
                        error: usageData.error
                    });
                }
            }

            // 3. ì›ë˜ ì…ë ¥ ìˆœì„œëŒ€ë¡œ ì •ë ¬í•˜ê³  ìµœì¢… ë°ì´í„°ì…‹ êµ¬ì„±
            sortedResultsByInput = [];
            for (const inputEndpoint of parsedEndpoints) {
                const matchingResult = rawCalculationResults.find(r => 
                    r.hoGi === inputEndpoint.hoGi && r.endTime === inputEndpoint.fullTimeStr
                );
                if (matchingResult) {
                    sortedResultsByInput.push(matchingResult);
                }
            }
            
            // AI ë¶„ì„ì„ ìœ„í•œ ê²°ê³¼ (usageê°€ ì •ìƒì ì¸ ê²ƒë§Œ í•„í„°ë§)
            cycleAnalysisResults = sortedResultsByInput.filter(r => r.usage !== 'N/A' && !r.error); 
            
            // 4. í…Œì´ë¸” ê·¸ë¦¬ê¸°, í•„í„° ì—…ë°ì´íŠ¸, ë³µì‚¬ ë„êµ¬ í‘œì‹œ
            
            // í•„í„°ë§ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ë° ì´ˆê¸° í•„í„° ì ìš© (ì´ë•Œ filterAndRedrawTableì´ í˜¸ì¶œë˜ì–´ ì •ë ¬ë¨)
            updateHoGiFilter();
            
            // (filterAndRedrawTable í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ë©´ì„œ í…Œì´ë¸”ê³¼ ë³µì‚¬ í‘œê°€ ëª¨ë‘ ì •ë ¬ë¨)

            const hasValidCopyData = sortedResultsByInput.some(r => r.endGas && r.endGas !== 'N/A');
            const hasValidResult = cycleAnalysisResults.length > 0;

            if (hasValidCopyData || hasValidResult) { 
                updateUIStatus(true);
                copyTools.classList.remove('hidden');
                document.querySelectorAll('.copy-column-btn').forEach(btn => btn.disabled = !hasValidCopyData);
            } else {
                updateUIStatus(false);
                copyTools.classList.add('hidden');
                gasResultsTable.innerHTML = '<span class="text-red-500 font-bold">âš ï¸ ì…ë ¥ëœ ì‹œì ì— í•´ë‹¹ë˜ëŠ” ê°€ìŠ¤ ëˆ„ì  ì§€ì¹¨ ë°ì´í„°ê°€ íŒŒì¼ì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‹œê°„ ë²”ìœ„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</span>';
            }
        };
        
        // --- Column Copy Functionality ---
        const copyColumnData = (copyKey) => {
            const copyMap = {
                'date': (r) => r.datePart,
                'startGas': (r) => r.startGas,
                'endGas': (r) => r.endGas,
                'hoGi': (r) => r.hoGi, // í˜¸ê¸° ë²ˆí˜¸ë§Œ ë³µì‚¬
                'usage': (r) => r.usage,
            };

            if (!copyMap[copyKey]) return;

            // í˜„ì¬ í•„í„°ë§ëœ í…Œì´ë¸” ë°ì´í„°ì…‹ì„ ê¸°ì¤€ìœ¼ë¡œ ë³µì‚¬ (filterAndRedrawTable ë¡œì§ì„ ë³µì œ)
            const currentHoGi = hoGiFilter.value;
            let sourceData;
            
            if (currentHoGi === 'all') {
                sourceData = [...sortedResultsByInput]; 
            } else {
                sourceData = sortedResultsByInput.filter(r => r.hoGi === currentHoGi);
            }
            
            // CRITICAL: ë³µì‚¬ ì „ì— Usage ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (í™”ë©´ì— ë³´ì´ëŠ” ìˆœì„œì™€ ì¼ì¹˜)
            sourceData.sort((a, b) => {
                const endGasA = parseFloat(a.endGas);
                const endGasB = parseFloat(b.endGas);

                if (isNaN(endGasA) && isNaN(endGasB)) return 0;
                if (isNaN(endGasA)) return 1;
                if (isNaN(endGasB)) return -1;
                
                return endGasB - endGasA; // Descending sort (ì‚¬ìš©í›„ ì§€ì¹¨ ê¸°ì¤€)
            });


            // ìœ íš¨í•œ ë³µì‚¬ ë°ì´í„°ë¥¼ ì¶”ì¶œ 
            const dataToCopy = sourceData.map(r => {
                const value = copyMap[copyKey](r);
                
                // N/A, ë¹ˆ ë¬¸ìì—´, ì˜¤ë¥˜ ì‹œ ë¹ˆ ê°’ ë³µì‚¬
                if (value === 'N/A' || !value || r.error && copyKey === 'usage') return ''; 
                if (copyKey === 'startGas' && r.startGas === '') return ''; // ì‹œì‘ ì§€ì¹¨ì´ ì—†ëŠ” ê²½ìš°

                // í˜¸ê¸°ëŠ” 'í˜¸ê¸°' ë¬¸ìì—´ ì—†ì´ ìˆ«ìë§Œ ë³µì‚¬
                if (copyKey === 'hoGi') return r.hoGi;
                
                return value;
            });

            const textToCopy = dataToCopy.join('\n');

            try {
                // í´ë¦½ë³´ë“œ ë³µì‚¬
                const tempInput = document.createElement('textarea');
                tempInput.value = textToCopy;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                // ë³µì‚¬ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                copyMessage.classList.add('opacity-100');
                setTimeout(() => {
                    copyMessage.classList.remove('opacity-100');
                }, 1500);

            } catch (err) {
                resultOutput.innerHTML = `âš ï¸ ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ ìë™ ë³µì‚¬ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            }
        };

        // ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.querySelectorAll('.copy-column-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const key = e.target.getAttribute('data-copy-key');
                copyColumnData(key);
            });
        });


        // --- Event Handlers & Initial Setup ---

        // UI ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ë¶„ì„ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        const updateUIStatus = (isCalculated = false) => {
            fileListElement.innerHTML = '';
            
            const historyReady = historyDataContent.length > 0;
            const summaryReady = summaryDataContent.length > 0;
            const inputHasValue = cycleEndpointsInput.value.trim() !== '';

            let statusHtml = '';

            // í•„ìˆ˜ íŒŒì¼ ìƒíƒœ
            if (historyReady) {
                statusHtml += `<li class="text-green-600 font-semibold">âœ… 1. í•„ìˆ˜: ì´ë ¥ ë°ì´í„° ë¡œë“œ ì™„ë£Œ (${(historyDataContent.length / 1024).toFixed(1)} KB)</li>`;
                cycleInputSection.classList.remove('hidden');
            } else {
                statusHtml += `<li class="text-red-500 font-semibold">âŒ 1. í•„ìˆ˜: ì´ë ¥ ë°ì´í„° (ê°€ìŠ¤ëˆ„ì ì§€ì¹¨)ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</li>`;
                cycleInputSection.classList.add('hidden');
            }

            // ì„ íƒ íŒŒì¼ ìƒíƒœ
            if (summaryReady) {
                statusHtml += `<li class="text-green-600">(ì„ íƒ) ì§‘ê³„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ (${(summaryDataContent.length / 1024).toFixed(1)} KB)</li>`;
            } else {
                statusHtml += `<li class="text-gray-500">(ì„ íƒ) ì§‘ê³„ ë°ì´í„° (ì¤‘ëŸ‰, ë‹¨ìœ„)ëŠ” ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</li>`;
            }

            fileListElement.innerHTML = statusHtml;

            // ìµœì¢… ë¶„ì„ ë²„íŠ¼ í™œì„±í™” ì¡°ê±´: 1. í•„ìˆ˜ íŒŒì¼(ì´ë ¥) ë¡œë“œ 2. ìœ íš¨í•œ ì…ë ¥ ê°’ 3. ê³„ì‚° ì™„ë£Œ
            if (historyReady && inputHasValue && isCalculated) {
                // ë³µì‚¬ ë²„íŠ¼ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ìµœì¢… ë¶„ì„ ë²„íŠ¼ í™œì„±í™”
                if (cycleAnalysisResults && cycleAnalysisResults.length > 0) {
                    analyzeButton.disabled = false;
                } else {
                    analyzeButton.disabled = true; // ë³µì‚¬í•  ìœ íš¨ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ AI ë¶„ì„ë„ ë¬´ì˜ë¯¸
                }

                if (!resultOutput.innerHTML.includes("ğŸ‰ ëª¨ë“  ì¤€ë¹„ ì™„ë£Œ!")) {
                    resultOutput.innerHTML = `<span class="text-green-600 font-bold">ğŸ‰ ëª¨ë“  ì¤€ë¹„ ì™„ë£Œ!</span> ì‹œê°í™”ëœ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ AI ë¶„ì„ ìš”ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`;
                }
            } else {
                analyzeButton.disabled = true;
                copyTools.classList.add('hidden');
                if (historyReady && !isCalculated) {
                     resultOutput.innerHTML = `âš ï¸ ì´ë ¥ ë°ì´í„°ëŠ” ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. 'ì‚¬ì´í´ ì¢…ë£Œ ì‹œì  ëª©ë¡'ì„ ì…ë ¥í•˜ê³  'ê°€ìŠ¤ ì‚¬ìš©ëŸ‰ ê³„ì‚°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`;
                } else if (!historyReady) {
                     resultOutput.innerHTML = `âš ï¸ ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ **ì´ë ¥ ë°ì´í„°(ê°€ìŠ¤ëˆ„ì ì§€ì¹¨ í¬í•¨)**ê°€ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤. íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.`;
                }
            }
        };


        // íŒŒì¼ ë‚´ìš© ì½ê¸° (ë©€í‹° íŒŒì¼ ì²˜ë¦¬ ë¡œì§)
        fileInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            
            // ë°ì´í„° ì´ˆê¸°í™”
            historyDataContent = '';
            summaryDataContent = '';
            historyDataArray = [];
            rawCalculationResults = [];
            sortedResultsByInput = [];
            cycleAnalysisResults = []; 
            gasResultsTable.innerHTML = 'N/A';
            copyTools.classList.add('hidden');

            if (files.length === 0) {
                updateUIStatus(false);
                return;
            }

            resultOutput.innerHTML = `<span class="text-blue-600">íŒŒì¼ì„ ì½ëŠ” ì¤‘ì…ë‹ˆë‹¤. íŒŒì¼ì˜ ì¢…ë¥˜ë¥¼ ì‹ë³„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>`;
            
            let allHistoryContents = '';
            let tempHistoryArray = [];
            let summaryCount = 0; // ì§‘ê³„ ë°ì´í„° ì¹´ìš´íŠ¸
            
            for (const file of files) {
                let content = null;
                const fileName = file.name.toLowerCase();

                if (fileName.endsWith('.xlsx')) {
                    try {
                        content = await readXlsx(file);
                    } catch (error) {
                        resultOutput.innerHTML = `âš ï¸ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜ (${file.name}): ${error.message}`;
                        updateUIStatus(false);
                        return;
                    }
                } else if (fileName.endsWith('.csv') || fileName.endsWith('.txt')) {
                    content = await readCsvTxt(file);
                } else {
                     resultOutput.innerHTML = `âš ï¸ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ (${file.name})ì…ë‹ˆë‹¤. CSV, TXT, XLSX íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.`;
                     updateUIStatus(false);
                     return;
                }
                
                if (content) {
                    // íŒŒì¼ ì¢…ë¥˜ ì‹ë³„ (ëŒ€ëµì ì¸ ì»¬ëŸ¼ëª… ê¸°ë°˜)
                    if (content.includes('ì¤‘ëŸ‰') || content.includes('ë‹¨ìœ„ê°€ìŠ¤ì‚¬ìš©ëŸ‰') || content.includes('ê°€ì—´ì‹œì‘ì¼ì‹œ')) {
                        // ì§‘ê³„ ë°ì´í„°ë¡œ ì‹ë³„
                        if (summaryCount === 0) {
                            summaryDataContent = content;
                            summaryCount++;
                        } else {
                            resultOutput.innerHTML = `âš ï¸ ì§‘ê³„ ë°ì´í„°ê°€ 2ê°œ ì´ìƒ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ê°€ì¥ ë§ˆì§€ë§‰ íŒŒì¼ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.`;
                        }
                    } else if (content.includes('ì˜¨ë„') && content.includes('ê°€ìŠ¤') && content.includes('ì‹œê°„') && content.includes('ê°€ìŠ¤ëˆ„ì ì§€ì¹¨')) {
                        
                        // [CRITICAL FIX]: íŒŒì¼ëª…ì—ì„œ í˜¸ê¸° ë²ˆí˜¸ë¥¼ ì¶”ì¶œí•˜ì—¬ ë°ì´í„°ì— ê°•ì œ ì£¼ì…
                        const hoGiMatch = fileName.match(/ê°€ì—´ë¡œ(\d{2})í˜¸ê¸°/);
                        const hoGiNum = hoGiMatch ? hoGiMatch[1] : null;

                        if (hoGiNum) {
                            // ì´ë ¥ ë°ì´í„°ë¥¼ í†µí•© ë°°ì—´ì— ì¶”ê°€
                            const parsedData = parseCSV(content, hoGiNum);
                            tempHistoryArray.push(...parsedData);
                            
                            // AI í”„ë¡¬í”„íŠ¸ìš© Contentë„ í†µí•©
                            if (!allHistoryContents.includes(content.split('\n')[0])) {
                                // ì²« ë²ˆì§¸ íŒŒì¼ì˜ í—¤ë”ë§Œ ì‚¬ìš©
                                allHistoryContents += content.split('\n')[0] + ',í˜¸ê¸°\n'; 
                            }
                            // ë°ì´í„° ë¶€ë¶„ë§Œ ì¶”ê°€ (í—¤ë” ì œì™¸)
                            allHistoryContents += content.split('\n').slice(1).map(line => line + ',' + hoGiNum).join('\n') + '\n';
                        } else {
                            resultOutput.innerHTML = `âš ï¸ íŒŒì¼ëª…ì—ì„œ í˜¸ê¸° ë²ˆí˜¸(ì˜ˆ: ê°€ì—´ë¡œ20í˜¸ê¸°)ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë ¥ íŒŒì¼ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`;
                            updateUIStatus(false);
                            return;
                        }
                    }
                }
            }
            
            // ìµœì¢…ì ìœ¼ë¡œ í†µí•©ëœ ì´ë ¥ ë°ì´í„° ì—…ë°ì´íŠ¸
            historyDataContent = allHistoryContents;
            historyDataArray = tempHistoryArray;


            // í•„ìˆ˜ ì»¬ëŸ¼ ëˆ„ë½ ìµœì¢… ì²´í¬ (ê°€ìŠ¤ëˆ„ì ì§€ì¹¨ì€ ì—¬ì „íˆ í•„ìˆ˜)
            if (historyDataContent && !historyDataContent.includes('ê°€ìŠ¤ëˆ„ì ì§€ì¹¨')) {
                 resultOutput.innerHTML = `âš ï¸ ì´ë ¥ ë°ì´í„°ì— **'ê°€ìŠ¤ëˆ„ì ì§€ì¹¨'** ì»¬ëŸ¼ì´ í¬í•¨ë˜ì–´ì•¼ ê³„ì‚°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`;
                 historyDataContent = ''; 
                 historyDataArray = [];
            } else if (historyDataArray.length === 0) {
                 resultOutput.innerHTML = `âš ï¸ ìœ íš¨í•œ ì´ë ¥ ë°ì´í„° íŒŒì¼ì„ ì°¾ê±°ë‚˜ ë¡œë“œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`;
            }


            updateUIStatus(false);
        });
        
        // ê°€ìŠ¤ ì‚¬ìš©ëŸ‰ ê³„ì‚° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        calculateButton.addEventListener('click', analyzeCycles);
        
        // ì…ë ¥ í•„ë“œ ê°’ì´ ë³€ê²½ë˜ë©´ ê³„ì‚° ê²°ê³¼ ì´ˆê¸°í™”
        cycleEndpointsInput.addEventListener('input', () => {
            rawCalculationResults = [];
            sortedResultsByInput = [];
            cycleAnalysisResults = []; 
            gasResultsTable.innerHTML = 'N/A';
            copyTools.classList.add('hidden');
            calculatedDataDisplay.value = ''; // NEW: í…ìŠ¤íŠ¸ ì˜ì—­ ì´ˆê¸°í™”
            updateHoGiFilter(); // í•„í„°ë§ ë©”ë‰´ ì´ˆê¸°í™”
            updateUIStatus(false);
        });

        // AI ë¶„ì„ ìš”ì²­ ë²„íŠ¼ ì²˜ë¦¬ (ì´ì „ ë²„ì „ê³¼ ë™ì¼)
        analyzeButton.addEventListener('click', async () => {
            if (cycleAnalysisResults.length === 0) return;

            // UI ìƒíƒœ ë³€ê²½
            analyzeButton.disabled = true;
            loadingSpinner.classList.remove('hidden');
            resultOutput.innerHTML = 'ë°ì´í„° ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...';

            // ë°ì´í„°ëŠ” ìµœëŒ€ 10,000ìë¡œ ì œí•œí•˜ì—¬ ì „ì†¡ (Gemini APIì˜ í† í° í•œê³„ ê³ ë ¤)
            const limitedHistory = historyDataContent.substring(0, 10000); 
            const limitedSummary = summaryDataContent.substring(0, 5000); 
            
            // ê³„ì‚°ëœ ê²°ê³¼ ìš”ì•½
            const cycleReport = cycleAnalysisResults.map(r => 
                `[${r.hoGi}í˜¸ê¸°, ${r.startTime.slice(5, 16)}~${r.endTime.slice(5, 16)}]: ${r.usage} NmÂ³ (ì‹œì‘ì§€ì¹¨: ${r.startGas}, ì¢…ë£Œì§€ì¹¨: ${r.endGas})`
            ).join('\n');
            
            // ì§‘ê³„ ë°ì´í„° ìœ ë¬´ì— ë”°ë¥¸ í”„ë¡¬í”„íŠ¸ ë¶„ê¸°
            const summaryPrompt = summaryDataContent.length > 0 ? 
                `
                **[2. ì§‘ê³„ ë°ì´í„° (ì¤‘ëŸ‰, ë‹¨ìœ„ê°€ìŠ¤ì‚¬ìš©ëŸ‰)]**
                - ë‚´ìš©: ì¼ë³„ ë˜ëŠ” ì‘ì—… ì‚¬ì´í´ë³„ 'ì¤‘ëŸ‰(kg)', 'ì´ ê°€ìŠ¤ ì‚¬ìš©ëŸ‰', 'ë‹¨ìœ„ê°€ìŠ¤ì‚¬ìš©ëŸ‰(Nm3/Ton)' ë“±ì˜ ì§‘ê³„ ì •ë³´ì…ë‹ˆë‹¤.
                - ë¶„ì„ ìš©ë„: ì „ë°˜ì ì¸ íš¨ìœ¨ ìˆ˜ì¤€ íŒŒì•… ë° ë¹„íš¨ìœ¨ì ì¸ ì‚¬ì´í´/ë‚ ì§œ ì‹ë³„.
                ---
                ${limitedSummary} 
                ---
                
                2. **[ì§‘ê³„ ë°ì´í„° ì—°ê´€ ë¶„ì„]** ì§‘ê³„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì´ ì‚¬ì´í´ì˜ íš¨ìœ¨ì´ ê³¼ê±° ëŒ€ë¹„ ì–´ë–¤ ìˆ˜ì¤€ì¸ì§€ íŒë‹¨í•˜ê³ , ê°œì„  ê°€ëŠ¥ì„±ì„ ì œì‹œí•˜ì„¸ìš”.
                ` 
                : 
                `
                **[2. ì§‘ê³„ ë°ì´í„° (ì¤‘ëŸ‰, ë‹¨ìœ„ê°€ìŠ¤ì‚¬ìš©ëŸ‰)]**
                - (ì§‘ê³„ ë°ì´í„°ê°€ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. íŒ¨í„´ ë¶„ì„ì—ë§Œ ì§‘ì¤‘í•´ ì£¼ì„¸ìš”.)
                `;


            // í”„ë¡¬í”„íŠ¸ êµ¬ì„± (ë‘ íŒŒì¼ ë‚´ìš© + ê³„ì‚°ëœ ê°€ìŠ¤ ì‚¬ìš©ëŸ‰ í†µí•©)
            const userQuery = `
                ë‹¤ìŒì€ íƒœì›…ì˜ ê°€ì—´ë¡œ íš¨ìœ¨ ë¶„ì„ì„ ìœ„í•œ ì´ë ¥ ë°ì´í„°ì™€ ${summaryDataContent.length > 0 ? 'ì„ íƒì  ì§‘ê³„ ë°ì´í„°' : 'ì¶”ê°€ ì§‘ê³„ ë°ì´í„° ì—†ì´'} **ë‹¤ìˆ˜ ì‚¬ì´í´ì˜ ì‹¤ì œ ê°€ìŠ¤ ì‚¬ìš©ëŸ‰ ê³„ì‚° ê²°ê³¼** ì •ë³´ì…ë‹ˆë‹¤.
                
                **[1. ì´ë ¥ ë°ì´í„° (ê°€ìŠ¤, ì˜¨ë„ - ë¶„ ë‹¨ìœ„ ì‹œê³„ì—´)]**
                - ë‚´ìš©: ë¶„ ë‹¨ìœ„ì˜ 'ì‹œê°„', 'ì‹¤ì œ ì˜¨ë„', 'ê°€ìŠ¤ ìœ ëŸ‰', 'ê°€ìŠ¤ëˆ„ì ì§€ì¹¨' ë“±ì˜ ì´ë ¥ì…ë‹ˆë‹¤.
                - ë¶„ì„ ìš©ë„: ê°€ì—´ íŒ¨í„´ ë¹„íš¨ìœ¨, ë¶ˆí•„ìš”í•œ ê³ ì˜¨ í™€ë”© êµ¬ê°„, ê°€ìŠ¤ Loss ì§€ì  ì‹ë³„.
                ---
                ${limitedHistory} 
                ---

                ${summaryPrompt}
                
                **[3. ë‹¤ìˆ˜ ì‚¬ì´í´ë³„ ê°€ìŠ¤ ì‚¬ìš©ëŸ‰ ë¶„ì„ ê²°ê³¼]**
                - **ë¶„ì„ ê²°ê³¼ (NmÂ³):**
                ${cycleReport}
                
                **[Nm3/Ton ì ˆê° ëª©í‘œ ì§‘ì¤‘ ë¶„ì„ ìš”ì²­]**
                ì œê³µëœ ì •ë³´ë¥¼ ì¢…í•©í•˜ì—¬ ê°€ìŠ¤ ì›ë‹¨ìœ„(Nm3/Ton) ì ˆê°ì„ ìœ„í•œ 3ê°€ì§€ ì‹¤í–‰ ê°€ëŠ¥í•œ ì•„ì´ë””ì–´ë¥¼ ë„ì¶œí•´ ì£¼ì„¸ìš”.
                
                1. **[ë¹„íš¨ìœ¨ ì‚¬ì´í´ ì‹ë³„]** ê³„ì‚°ëœ ì‚¬ìš©ëŸ‰ì´ ê°€ì¥ ë†’ì€ ì‚¬ì´í´(ê°€ìŠ¤ ì‚¬ìš©ëŸ‰ ìˆ˜ì¹˜ ë° ì´ë ¥ ë°ì´í„° íŒ¨í„´)ì„ ê¸°ì¤€ìœ¼ë¡œ, í•´ë‹¹ ì‚¬ì´í´ì—ì„œ ê°€ìŠ¤ ì†Œë¹„ë¥¼ ë¹„ì •ìƒì ìœ¼ë¡œ ë†’ì¸ **ê°€ì—´ íŒ¨í„´ ë¹„íš¨ìœ¨ì„± (ì˜ˆ: ê³¼ë„í•œ í™€ë”©, ëª©í‘œ ì˜¨ë„ ì´ˆê³¼ ìœ ì§€)**ì„ ìƒì„¸ ë¶„ì„í•˜ì„¸ìš”.
                ${summaryDataContent.length > 0 ? '' : '// ì§‘ê³„ ë°ì´í„°ê°€ ì—†ìœ¼ë¯€ë¡œ 2ë²ˆ í•­ëª©ì€ ìƒëµí•©ë‹ˆë‹¤.'}
                
                ê²°ê³¼ í˜•ì‹:
                1. [ë¶„ì„ í†µì°°ë ¥] ì œê³µëœ ì •ë³´ë¥¼ ê²°í•©í•˜ì—¬ ë°œê²¬ëœ ê°€ì¥ ì¤‘ìš”í•œ ë¹„íš¨ìœ¨ íŒ¨í„´ ë° Loss ì§€ì  ìš”ì•½.
                2. [ê°€ì¥ í˜„ì‹¤ì ì¸ ì•„ì´ë””ì–´] ITíŒ€ ì§€ì› ì—†ì´ ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ ê³µì • ê°œì„  ì•„ì´ë””ì–´ (ì˜ˆ: ì‘ì—…ì êµìœ¡, ì˜¤í¼ë ˆì´ì…˜ ë³€ê²½).
                3. [ë„ì „ì  ì•„ì´ë””ì–´] ë‹¨ê¸°ì  íˆ¬ì ë˜ëŠ” í˜‘ì—…ì´ í•„ìš”í•˜ì§€ë§Œ íš¨ê³¼ê°€ í° ì•„ì´ë””ì–´ (ì˜ˆ: ì„¼ì„œ í™œìš©, ì‹œìŠ¤í…œ ê°œì„ ).
            `;

            const systemPrompt = "ë‹¹ì‹ ì€ ììœ í˜•ë‹¨ì¡°ê¸°ì—…ì˜ 20ë…„ ê²½ë ¥ ìƒì‚° ê³µì • ì „ë¬¸ê°€ì´ì ì—ë„ˆì§€ íš¨ìœ¨ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤. í•­ìƒ Nm3/Ton ì ˆê° ëª©í‘œì— ì´ˆì ì„ ë§ì¶”ì–´ êµ¬ì²´ì ì´ê³  ì‹¤ì§ˆì ì¸ ê°œì„  ì•„ì´ë””ì–´ë¥¼ ì œì‹œí•˜ì‹­ì‹œì˜¤. ì¶”ìƒì ì¸ ì„¤ëª…ì€ í”¼í•˜ê³ , ìˆ«ìë¡œ ì¸¡ì • ê°€ëŠ¥í•œ í–‰ë™ í•­ëª© ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "ë¶„ì„ ê²°ê³¼ë¥¼ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë°ì´í„° í˜•ì‹ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";

                    resultOutput.innerHTML = text;
                    break;

                } catch (error) {
                    console.error("Gemini API í˜¸ì¶œ ì˜¤ë¥˜:", error);
                    resultOutput.innerHTML = `âš ï¸ í†µì‹  ì˜¤ë¥˜ ë°œìƒ: ${error.message}. API í‚¤ì™€ ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”ã€‚`;
                }
            }

            // UI ìƒíƒœ ë³µêµ¬
            analyzeButton.disabled = false;
            loadingSpinner.classList.add('hidden');
        });

    </script>
</body>
</html>
